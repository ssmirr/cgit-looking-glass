# lighttpd configuration for cgit
# Included via /etc/lighttpd/conf-enabled/20-cgit.conf
# Anubis reverse-proxies to lighttpd on 127.0.0.1:8080
#
# NOTE: server.bind, server.port, and server.document-root are patched
# in the main lighttpd.conf by setup.sh — lighttpd does not allow
# reassignment of these directives in included files.
#
# Required modules (enabled by setup.sh):
#   mod_cgi, mod_rewrite, mod_setenv, mod_expire, mod_accesslog

# ---------------------------------------------------------------------------
# Performance tuning for constrained boxes
# ---------------------------------------------------------------------------
server.max-connections  = 128
server.max-fds          = 256
server.max-keep-alive-requests = 6
server.max-keep-alive-idle     = 10
server.max-request-size = 1024

# Disable stat cache to keep memory minimal
server.stat-cache-engine = "disable"

# ---------------------------------------------------------------------------
# CGI — cgit binary
# ---------------------------------------------------------------------------
cgi.assign = ( "/cgit.cgi" => "" )

# ---------------------------------------------------------------------------
# URL rewriting — clean URLs via cgit
# ---------------------------------------------------------------------------
url.rewrite-once = (
    "^/cgit\.css$"     => "/cgit.css",
    "^/cgit\.js$"      => "/cgit.js",
    "^/favicon\.svg$"  => "/favicon.svg",
    "^/(.*)$"          => "/cgit.cgi/$1"
)

# ---------------------------------------------------------------------------
# Security headers
# Since lighttpd is behind Anubis which is behind Cloudflare,
# these are defense-in-depth
# ---------------------------------------------------------------------------
setenv.add-response-header = (
    "X-Content-Type-Options"  => "nosniff",
    "X-Frame-Options"         => "DENY",
    "Referrer-Policy"         => "strict-origin-when-cross-origin",
    "Permissions-Policy"      => "camera=(), microphone=(), geolocation=()"
)

# ---------------------------------------------------------------------------
# Cache-Control headers — Cloudflare respects these at the edge
#
# Strategy:
#   - Static assets (CSS/JS/SVG): 30 days, immutable
#   - Immutable views (commit, tree, blob, diff, snapshot):
#     1 hour at edge — content never changes for a given hash
#   - Dynamic views (log, refs, summary, index): 5 min — changes on sync
#   - Default CGI responses: 2 min — safe fallback
#
# Cloudflare needs "public" + explicit max-age to cache HTML.
# s-maxage controls edge TTL independently of browser TTL.
# CDN-Cache-Control is Cloudflare-specific and takes priority.
#
# lighttpd applies ALL matching conditional blocks, and the last one's
# setenv directives win. We use else-chaining so only the first match
# applies, giving us predictable first-match-wins semantics.
# ---------------------------------------------------------------------------

# 1. Static assets — long cache, immutable
$HTTP["url"] =~ "\.(css|js|svg|png|ico)$" {
    expire.url = ( "" => "access plus 30 days" )
    setenv.add-response-header += (
        "Cache-Control" => "public, max-age=2592000, immutable"
    )
}

# 2-7: CGI responses — else-chained for first-match-wins
# 2. Snapshot downloads — immutable archives
$HTTP["url"] =~ "/cgit\.cgi/.+/snapshot/" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=3600, s-maxage=86400, immutable",
        "CDN-Cache-Control" => "max-age=86400"
    )
}
# 3. Immutable content — commit/tree/blob/diff/patch pinned to a hash
else $HTTP["url"] =~ "/cgit\.cgi/.+/(commit|tree|diff|blob|patch)/" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=300, s-maxage=3600",
        "CDN-Cache-Control" => "max-age=3600"
    )
}
# 4. Log and refs views — change on mirror sync (every 30 min)
else $HTTP["url"] =~ "/cgit\.cgi/.+/(log|refs)(/|$)" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=120, s-maxage=300",
        "CDN-Cache-Control" => "max-age=300"
    )
}
# 5. Repo summary pages
else $HTTP["url"] =~ "/cgit\.cgi/[^/]+\.git/?$" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=120, s-maxage=300",
        "CDN-Cache-Control" => "max-age=300"
    )
}
# 6. Root index (repo list)
else $HTTP["url"] =~ "^/cgit\.cgi/?$" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=120, s-maxage=300",
        "CDN-Cache-Control" => "max-age=300"
    )
}
# 7. Default fallback for any other CGI response
else $HTTP["url"] =~ "/cgit\.cgi" {
    setenv.add-response-header += (
        "Cache-Control"     => "public, max-age=60, s-maxage=120",
        "CDN-Cache-Control" => "max-age=120"
    )
}

# ---------------------------------------------------------------------------
# Disable directory listing
# ---------------------------------------------------------------------------
dir-listing.activate = "disable"
